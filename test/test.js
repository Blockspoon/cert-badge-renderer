const fs = require("fs");
const {
  generateAchievementHTML,
} = require("../dist/utils/generateAchievementHTML");
const {
  generateAchievementFile,
} = require("../dist/utils/generateAchievementFile");
const fsPromises = require("fs").promises;
const path = require("path");

const test_object = {
  statusCode: 200,
  message: "인증서가 조회되었습니다.",
  achievement: {
    id: 1539,
    admin_comment: null,
    level: null,
    nft_token: null,
    issuance_route: "manual",
    certificate_number: "SAND-202504-r9a1pt",
    course_begin_at: "2025-04-01T00:00:00.000Z",
    course_end_at: "2025-04-07T00:00:00.000Z",
    expiration_date: null,
    is_received: false,
    status: "ISSUED",
    issuance_method: "EMAIL",
    created_at: "2025-04-06T21:40:39.316Z",
    updated_at: "2025-04-06T21:40:55.500Z",
    user: {
      id: 2107,
      email: "kolleges1234@gmail.com",
      name: "칼리지스 헬퍼",
    },
    customAttributes: [],
    achievementForm: {
      id: 551,
      name: "sandbox-achievement",
      description: "sandbox-achievement",
      type: "completion",
      tags: ["sandbox", "test", "api"],
      prefix: "SAND",
      program_type: "community",
      program_name: "kolleges",
      program_url: "https://landing.kolleges.net/",
      course_begin_at: "2025-04-01T00:00:00.000Z",
      course_end_at: "2025-04-07T00:00:00.000Z",
      created_at: "2025-04-06T21:38:26.918Z",
      updated_at: "2025-04-06T21:38:26.918Z",
      club: {
        domain: "sandbox",
        name: "Kolleges API Sandbox",
        type: "community",
        images: [
          {
            path: "uploads/club/symbol/7ed92a1b-d87f-4ddb-9af6-ae8fd7403e36",
            type: "club_symbol",
          },
          {
            path: "uploads/club/cover/d962e0ba-b981-4ff8-96ab-0a0f325ddb8a",
            type: "club_cover",
          },
          {
            path: "uploads/club/logo/91e4d176-4df8-46a7-bbbc-ee4a2bb72d6a",
            type: "club_logo",
          },
        ],
      },
      clubInstitutions: [],
      representativeInstitution: {
        name: "Kolleges API Sandbox",
        type: "community",
        images: [
          {
            path: "https://ufcglnoegwgklehhpzlj.supabase.co/storage/v1/object/public/blockspoon_images/uploads/club/symbol/7ed92a1b-d87f-4ddb-9af6-ae8fd7403e36",
            type: "club_symbol",
          },
          {
            path: "https://ufcglnoegwgklehhpzlj.supabase.co/storage/v1/object/public/blockspoon_images/uploads/club/cover/d962e0ba-b981-4ff8-96ab-0a0f325ddb8a",
            type: "club_cover",
          },
          {
            path: "https://ufcglnoegwgklehhpzlj.supabase.co/storage/v1/object/public/blockspoon_images/uploads/club/logo/91e4d176-4df8-46a7-bbbc-ee4a2bb72d6a",
            type: "club_logo",
          },
        ],
        website_url: "http://localhost:3000/sandbox",
      },
      requirements: [
        {
          type: "submit_homework",
          url: "https://admin.kolleges.net/ko/onboard/sign_in",
          description: "kolleges main",
        },
        {
          type: "read",
          url: "https://landing.kolleges.net/",
          description: "kolleges landing",
        },
      ],
      achievementCertificateDesign: {
        id: 139,
        name: "OpenApi1",
        main_color: "#1C2A54",
        sub_color: "#09B3EA",
        extra_color_1: null,
        extra_color_2: null,
        layout_json: [
          {
            controlType: "line",
            designType: "element",
            verticalAlign: "middle",
            textAlign: "center",
            color: "#09B3EA",
            width: 265,
            height: 10,
            x: 272.5,
            y: 244,
            lineWidth: 2,
            isVertical: false,
            order: 0,
            id: "0",
          },
          {
            controlType: "line",
            designType: "element",
            verticalAlign: "middle",
            textAlign: "center",
            color: "#1C2A54",
            width: 265,
            height: 10,
            x: 272.5,
            y: 243,
            lineWidth: 1,
            isVertical: false,
            order: 1,
            id: "1",
          },
          {
            controlType: "line",
            designType: "element",
            verticalAlign: "middle",
            textAlign: "center",
            color: "#000000",
            width: 160,
            height: 10,
            x: 105,
            y: 952,
            lineWidth: 1,
            isVertical: false,
            order: 2,
            id: "2",
          },
          {
            controlType: "line",
            designType: "element",
            verticalAlign: "middle",
            textAlign: "center",
            color: "#000000",
            width: 160,
            height: 10,
            x: 546,
            y: 951,
            lineWidth: 1,
            isVertical: false,
            order: 3,
            id: "3",
          },
          {
            controlType: "text",
            designType: "text",
            text: "CERTIFICATE of QUALIFICATION",
            fontSize: 24,
            fontWeight: "700",
            textAlign: "left",
            fontFamily: "'BR Firma', sans-serif",
            width: 400,
            height: 50,
            x: 205,
            y: 200,
            order: 4,
            id: "4",
          },
          {
            controlType: "text",
            designType: "props",
            type: "achievement",
            bindingKey: "name",
            text: "[인증서.제목]",
            fontSize: 48,
            fontWeight: "700",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 666,
            height: 60,
            x: 71,
            y: 274,
            order: 5,
            id: "5",
          },
          {
            controlType: "text",
            designType: "props",
            type: "user",
            bindingKey: "name",
            text: "[수령자.이름]",
            fontSize: 40,
            fontWeight: "600",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 235,
            height: 60,
            x: 280,
            y: 384,
            order: 6,
            id: "6",
          },
          {
            controlType: "text",
            designType: "props",
            type: "achievement",
            bindingKey: "description",
            text: "[인증서.설명]",
            fontSize: 24,
            fontWeight: "400",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 666,
            height: 70,
            x: 71,
            y: 611,
            order: 7,
            id: "7",
          },
          {
            controlType: "text",
            designType: "props",
            type: "achievement",
            bindingKey: "tags",
            text: "[인증서.스킬태그]",
            fontSize: 16,
            fontWeight: "400",
            textAlign: "center",
            color: "#6B7684",
            fontFamily: "Pretendard, sans-serif",
            width: 666,
            height: 21,
            x: 71,
            y: 713,
            order: 8,
            id: "8",
          },
          {
            controlType: "text",
            designType: "text",
            text: "수료기간",
            fontSize: 16,
            fontWeight: "400",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            color: "#6B7684",
            width: 150,
            height: 21,
            x: 330,
            y: 518,
            order: 9,
            id: "9",
          },
          {
            controlType: "text",
            designType: "props",
            type: "achievement",
            bindingKey: "period",
            text: "[인증서.수료기간]",
            fontSize: 24,
            fontWeight: "500",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 335,
            height: 50,
            x: 243,
            y: 551,
            order: 10,
            id: "10",
          },
          {
            controlType: "text",
            designType: "text",
            text: "발급일",
            fontSize: 16,
            fontWeight: "600",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 150,
            height: 21,
            x: 110,
            y: 929,
            order: 11,
            id: "11",
          },
          {
            controlType: "text",
            designType: "props",
            type: "achievement",
            bindingKey: "created_at",
            text: "[인증서.발급일]",
            fontSize: 16,
            fontWeight: "400",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 200,
            height: 21,
            x: 84,
            y: 956,
            order: 12,
            id: "12",
          },
          {
            controlType: "text",
            designType: "text",
            text: "발급기관",
            fontSize: 16,
            fontWeight: "600",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 150,
            height: 21,
            x: 551,
            y: 927,
            order: 13,
            id: "13",
          },
          {
            controlType: "text",
            designType: "props",
            type: "club",
            bindingKey: "name",
            text: "[발급기관[1].이름]",
            fontSize: 16,
            fontWeight: "400",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 200,
            height: 70,
            x: 526,
            y: 956,
            order: 14,
            id: "14",
          },
        ],
        template_type: "NewCertificateType2",
      },
      achievementBadgeDesign: {
        id: 63,
        name: "OpenApi1",
        main_color: "#94896B",
        sub_color: null,
        extra_color_1: null,
        extra_color_2: null,
        layout_json: [
          {
            controlType: "svg",
            designType: "badge",
            componentName: "BadgeType31",
            background: "transparent",
            width: 538,
            height: 594,
            x: 31.00006103515625,
            y: 3,
            text: "BadgeType31",
            mainColor: "#322899",
            subColor: "#7368E8",
            order: 0,
            id: "0",
          },
          {
            controlType: "svg",
            designType: "icon",
            componentName: "IconMortarboard3",
            background: "transparent",
            width: 240,
            height: 222,
            x: 188,
            y: 134,
            text: "IconMortarboard3",
            mainColor: "#322899",
            subColor: "#7468e8",
            extraColor1: "#ffffff",
            order: 1,
            id: "1",
          },
          {
            controlType: "text",
            designType: "text",
            text: "· CERTIFICATE of COMPLETION ·",
            fontSize: 16,
            fontWeight: "600",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            color: "white",
            width: 332,
            height: 50,
            x: 135,
            y: 122,
            order: 2,
            id: "2",
          },
          {
            controlType: "text",
            designType: "props",
            type: "achievement",
            bindingKey: "name",
            text: "[인증서.제목]",
            fontSize: 40,
            fontWeight: "700",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            color: "black",
            width: 375,
            height: 108,
            x: 115,
            y: 398,
            order: 3,
            id: "3",
          },
          {
            controlType: "image",
            designType: "props",
            type: "club",
            bindingKey: "club_symbol",
            src: "",
            text: "[발급기관[1].심볼]",
            fontSize: 16,
            fontWeight: "400",
            textAlign: "center",
            fontFamily: "Pretendard, sans-serif",
            width: 65,
            height: 65,
            x: 415,
            y: 243,
            order: 4,
            id: "4",
          },
        ],
        template_type: "NewBadgeType48",
      },
    },
    achievementFormId: 551,
  },
};

const testCertificateData = {
  user: test_object.achievement.user,
  kollegeInfo: test_object.achievement.achievementForm.club,
  achievementInfo: test_object.achievement,
};
const testOptions = {
  type: "badge",
  size: 300,
  returnType: "base64",
};

async function runTests() {
  try {
    // HTML 변환 테스트
    const htmlOutput = await generateAchievementHTML(
      testCertificateData,
      {
        type: "badge",
        size: 300,
        noSpace: false,
        mainColor: "#322899",
        subColor: "#7368E8"
      }
    );
    fs.writeFileSync("test/certificate.html", htmlOutput, "utf8");
    console.log("✅ HTML 변환 완료: test/certificate.html");

    // PNG 변환 테스트
    const pngResult = await generateAchievementFile(
      testCertificateData,
      testOptions
    );

    if (testOptions.returnType === "base64") {
      console.log("✅ Base64 변환 완료");
      // base64 문자열에서 data:image/png;base64, 부분 제거
      const base64Data = pngResult.base64.replace(
        /^data:image\/png;base64,/,
        ""
      );
      // base64를 버퍼로 변환
      const buffer = Buffer.from(base64Data, "base64");
      // 이미지 파일로 저장
      await fsPromises.writeFile(
        path.join(__dirname, "certificate_base64.png"),
        buffer
      );
      console.log("✅ Base64 이미지 저장 완료: test/certificate_base64.png");
    } else {
      await fsPromises.writeFile(
        path.join(__dirname, "certificate.png"),
        pngResult.buffer
      );
      console.log("✅ PNG 변환 완료: test/certificate.png");
    }
  } catch (error) {
    console.error("❌ 테스트 실행 중 오류 발생:", error);
  }
}

runTests();
